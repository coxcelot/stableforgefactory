name: Deploy Frontend to GitHub Pages

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # No build step needed â€” static HTML only
      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Download deploy artifacts (if any)
        uses: actions/download-artifact@v4
        with:
          name: stableforge-deploy
          path: deploy_artifacts
        continue-on-error: true

      - name: Inject Factory Address into frontend (if available)
        run: |
          if [ -f deploy_artifacts/deploy.out ]; then
            FACTORY_ADDR=$(grep -E "StableForgeFactory:" deploy_artifacts/deploy.out | awk '{print $2}')
            echo "Found factory address: $FACTORY_ADDR"
            # Replace placeholder with BaseScan link
            sed -i "s|FACTORY_ADDRESS_PLACEHOLDER|<a href=\"https://basescan.org/address/${FACTORY_ADDR}\" target=\"_blank\">${FACTORY_ADDR}</a>|g" frontend/index.html || true
          else
            echo "No deploy.out found; skipping injection"
          fi

      - name: Upload frontend
        uses: actions/upload-pages-artifact@v3
        with:
          path: frontend

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
