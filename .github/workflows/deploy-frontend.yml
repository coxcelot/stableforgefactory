name: Deploy Frontend to GitHub Pages

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      PK: ${{ secrets.PK }}
      BASE_RPC: ${{ secrets.BASE_RPC }}
      AAVE_POOL: ${{ secrets.AAVE_POOL }}
      AERODROME_ROUTER: ${{ secrets.AERODROME_ROUTER }}
      AERODROME_FACTORY: ${{ secrets.AERODROME_FACTORY }}
      USDC: ${{ secrets.USDC }}
      CREATOR: ${{ secrets.CREATOR }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install deps
        run: npm install

      - name: Compile contracts
        run: npx hardhat compile

      - name: Deploy StableForgeFactory
        run: |
          npx hardhat run scripts/deploy.ts --network base | tee deploy.out

      - name: Inject factory and token addresses into frontend
        run: |
          FACTORY_ADDR=$(grep -E "StableForgeFactory:" deploy.out | awk '{print $2}')
          echo "Factory address: $FACTORY_ADDR"
          sed -i "s|<!--FACTORY_PLACEHOLDER-->|<a href=\"https://basescan.org/address/${FACTORY_ADDR}\" target=\"_blank\">${FACTORY_ADDR}</a>|" frontend/index.html || true

          # Extract deployed token addresses (assuming deploy.out logs them as 'Token: <addr>')
          TOKENS=$(grep -E "Token:" deploy.out | awk '{print $2}')
          i=1
          for addr in $TOKENS; do
            echo "Injecting token $i: $addr"
            sed -i "s|<!--TOKEN_PLACEHOLDER_${i}-->|<a href=\"https://basescan.org/address/${addr}\" target=\"_blank\">${addr}</a>|g" frontend/index.html || true
            i=$((i+1))
          done

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload frontend
        uses: actions/upload-pages-artifact@v3
        with:
          path: frontend

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
